@page "/counter"
@using BlazorStateApp.Services
@inject SessionStateManager SessionStateManager
@inject PersistentComponentState ApplicationState
@inject ILogger<Counter> Logger
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Counter</PageTitle>

<h1>Counter with State Persistence (.NET 10)</h1>

<div class="alert alert-info" role="alert">
    <strong>Per-Tab State Demo:</strong> Each browser tab maintains its own counter state that persists across server restarts!
    @if (!string.IsNullOrEmpty(tabId))
    {
        <br /><small>Tab ID: @tabId.Substring(0, 8)...</small>
    }
    <br /><small>Using: .NET 10 PersistentComponentState + sessionStorage (per-tab isolation)</small>
</div>

<p role="status">Current count: <strong>@currentCount</strong></p>

<div class="btn-group" role="group">
    <button class="btn btn-primary" @onclick="IncrementCount">Increment</button>
    <button class="btn btn-secondary" @onclick="DecrementCount">Decrement</button>
    <button class="btn btn-warning" @onclick="ResetCount">Reset</button>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-success mt-3" role="alert">
        @statusMessage
    </div>
}

@code {
    private int currentCount = 0;
    private string statusMessage = string.Empty;
    private string? tabId;
    private PersistingComponentStateSubscription persistingSubscription;
    private const string StateKey = "Counter_currentCount";

    protected override async Task OnInitializedAsync()
    {
        // Get the per-tab session ID from sessionStorage
        tabId = await SessionStateManager.GetSessionIdAsync();
        
        // First try to restore from PersistentComponentState (for immediate reconnections)
        if (ApplicationState.TryTakeFromJson<int>(StateKey, out var restoredCount))
        {
            currentCount = restoredCount;
            Logger.LogInformation("Counter state restored from PersistentComponentState: {Count}", currentCount);
            statusMessage = $"State restored! Count: {currentCount}";
        }
        else
        {
            // If not in PersistentComponentState, try to load from file storage (for server restarts)
            var state = await SessionStateManager.LoadComponentStateAsync<CounterState>(StateKey);
            if (state != null)
            {
                currentCount = state.Count;
                Logger.LogInformation("Counter state loaded from file storage for tab {TabId}: {Count}", tabId, currentCount);
                statusMessage = $"State restored! Count: {currentCount}";
            }
            else
            {
                // No saved state, start at 0
                currentCount = 0;
                Logger.LogInformation("No saved state found for tab {TabId}, starting at 0", tabId);
            }
        }

        // Register callback to persist state when circuit is being torn down
        persistingSubscription = ApplicationState.RegisterOnPersisting(PersistState);
    }

    private async Task PersistState()
    {
        // Save to PersistentComponentState for quick reconnections
        ApplicationState.PersistAsJson(StateKey, currentCount);
        
        // Also save to file storage for cross-server-restart persistence
        var state = new CounterState { Count = currentCount };
        await SessionStateManager.SaveComponentStateAsync(StateKey, state);
        
        Logger.LogInformation("Counter state persisted for tab {TabId}: {Count}", tabId, currentCount);
    }

    private async Task IncrementCount()
    {
        currentCount++;
        await SaveState();
        ClearStatusMessageAfterDelay();
    }

    private async Task DecrementCount()
    {
        currentCount--;
        await SaveState();
        ClearStatusMessageAfterDelay();
    }

    private async Task ResetCount()
    {
        currentCount = 0;
        await SaveState();
        ClearStatusMessageAfterDelay();
    }

    private async Task SaveState()
    {
        // Save to file storage for cross-server-restart persistence
        var state = new CounterState { Count = currentCount };
        await SessionStateManager.SaveComponentStateAsync(StateKey, state);
    }

    private async void ClearStatusMessageAfterDelay()
    {
        if (!string.IsNullOrEmpty(statusMessage))
        {
            await Task.Delay(3000);
            statusMessage = string.Empty;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        persistingSubscription.Dispose();
    }

    public class CounterState
    {
        public int Count { get; set; }
    }
}


